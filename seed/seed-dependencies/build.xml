<?xml version="1.0" encoding="UTF-8"?>

<project name="build" basedir="." default="build">

	<description>
		<!-- ==\_/========================================================== -->
		<!--  \(_)/                                                          -->
		<!--  -(_)-                                                          -->
		<!--  /(_)\                                                          -->
		<!-- =============================================================== -->
		<!--                                                                 -->
		<!-- Script for managing JavaScript libraries as Maven dependnecies. -->
		<!--                                                                 -->
		<!-- @author: Jose Badeau, jose.badeau@gmail.com                     -->
		<!--                                                                 -->
		<!-- =============================================================== -->
	</description>

	<!-- =================================================================== -->
	<!-- Properties.                                                         -->
	<!-- =================================================================== -->
	<condition property="maven_exec" value="mvn">
		<os family="unix" />
	</condition>
	<condition property="maven_exec" value="mvn.bat">
		<os family="windows" />
	</condition>
	<property name="maven_goal" value="install:install-file" />
	<property name="source" value="src/main/javascript" />
	<property name="target" value="target/lib" />

	<taskdef resource="net/sf/antcontrib/antlib.xml" classpath="${runtime_classpath}" />
	<taskdef resource="org/apache/maven/artifact/ant/antlib.xml" uri="antlib:org.apache.maven.artifact.ant" classpath="${runtime_classpath}" />

	<!-- list of JavaScript dependencies -->
	<property name="list">
		com.cujojs:curl:0.7.3,
		com.cujojs:wire:0.9.4,
		com.cujojs:cola:0.1.0-SNAPSHOT,
		com.cujojs:when:2.0.1,
		com.cujojs:meld:1.3.0,
		com.cujojs:poly:0.5.1,
		com.pivotallabs:jasmine:1.3.1
	</property>

	<!-- =================================================================== -->
	<!-- Public Targets                                                      -->
	<!-- =================================================================== -->
	<target name="build" depends="package, install" description="Install JavaScript dependencies into the local maven repository." />

	<!-- =================================================================== -->
	<!-- Private Targets:                                                    -->
	<!-- =================================================================== -->
	<target name="package">
		<forEachDependency list="${list}">
			<do>
				<zip basedir="${source}" includes="${artifactId}/**" destfile="${target}/${artifactId}.jar" whenempty="fail" />
			</do>
		</forEachDependency>
	</target>

	<target name="install">
		<forEachDependency list="${list}">
			<do>
				<echo message="${maven_exec} ${maven_goal} -Dfile=${target}/${artifactId}.jar -DgroupId=${groupId} -DartifactId=${artifactId} -Dversion=${version} -Dclassifier=javascript -Dpackaging=jar" />
				<exec executable="${maven_exec}" failifexecutionfails="true" failonerror="true">
					<arg value="${maven_goal}" />
					<arg value="-Dfile=${target}/${artifactId}.jar" />
					<arg value="-DgroupId=${groupId}" />
					<arg value="-DartifactId=${artifactId}" />
					<arg value="-Dversion=${version}" />
					<arg value="-Dclassifier=js" />
					<arg value="-Dpackaging=jar" />
				</exec>
			</do>
		</forEachDependency>
	</target>

	<macrodef name="forEachDependency" description="Divides up the list attribute into tupels consisting of groupId, artifactId and version">
		<attribute name="list" />
		<element name="do" optional="yes" />
		<sequential>
			<for list="@{list}" delimiter="," param="letter" trim="true">
				<sequential>
					<property name="regex" value="([^:]*):([^:]*):([^:]*)" />
					<propertyregex property="groupId" input="@{letter}" regexp="${regex}" select="\1" casesensitive="false" override="true" />
					<propertyregex property="artifactId" input="@{letter}" regexp="${regex}" select="\2" casesensitive="false" override="true" />
					<propertyregex property="version" input="@{letter}" regexp="${regex}" select="\3" casesensitive="false" override="true" />
					<echo>groupId: ${groupId} artifactId: ${artifactId} version: ${version}</echo>
					<do />
				</sequential>
			</for>
		</sequential>
	</macrodef>

</project>